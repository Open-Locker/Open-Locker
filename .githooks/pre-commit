#!/bin/sh
echo "Starting Hook Manager..."

# Find out which files have changed
CHANGED_FILES=$(git diff --cached --name-only)

# Define projects in the monorepo
PROJECTS="locker-backend"

# Error status variable (in case a hook fails)
HOOK_FAILED=0

# Determine the root directory of the repo
REPO_ROOT=$(git rev-parse --show-toplevel)

# Iterate through each project and check if it has its own hook
for PROJECT in $PROJECTS; do
  if echo "$CHANGED_FILES" | grep -q "^$PROJECT/"; then
    HOOK_PATH="$REPO_ROOT/$PROJECT/.githooks/pre-commit"

    if [ -f "$HOOK_PATH" ]; then
      echo "üöÄ Running hook for $PROJECT..."
      chmod +x "$HOOK_PATH"  # If necessary

      # Execute hook, catch errors, and tag output with project name
      (cd "$REPO_ROOT/$PROJECT" && "$HOOK_PATH") || HOOK_FAILED=1
    else
      echo "‚úÖ No hook found for $PROJECT ‚Äì skipped."
    fi
  fi
done

# If a hook fails, abort the commit
if [ $HOOK_FAILED -ne 0 ]; then
  echo "‚ùå At least one hook failed. Commit aborted."
  exit 1
fi

echo "‚úÖ All hooks executed successfully."
exit 0
