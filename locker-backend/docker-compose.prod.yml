services:
  app:
    image: ghcr.io/open-locker/locker-backend:${BACKEND_IMAGE_TAG:-latest}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    # ports:
      # Expose the app port via reverse proxy
      # - "${APP_PORT:-80}:8080"
    environment:
      AUTORUN_ENABLED: "true"
      AUTORUN_LARAVEL_MIGRATION_ISOLATION: "true"
      PUID: "1000"
      PGID: "1000"
      WWWUSER: "1000"
      LARAVEL_SAIL: 0
      APP_ENV: production
      APP_DEBUG: false
      DB_HOST: db
      REDIS_HOST: redis
      MQTT_BROKER_HOST: mqtt
    volumes:
      # Mount storage for persistent file uploads
      - "locker-storage:/var/www/html/storage/app/public"
      # Persist logs if needed
      # - "locker-logs:/var/www/html/storage/logs"
    networks:
      - locker-net
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/up"]
      interval: 5s
      timeout: 5s
      retries: 5
  queue-worker:
    image: ghcr.io/open-locker/locker-backend:${BACKEND_IMAGE_TAG:-latest}
    restart: unless-stopped
    stop_signal: SIGTERM
    environment:
      AUTORUN_ENABLED: "false"
      PUID: "1000"
      PGID: "1000"
      WWWUSER: "1000"
      APP_ENV: production
      DB_HOST: db
      REDIS_HOST: redis
      MQTT_BROKER_HOST: mqtt
    command: "php artisan queue:work --queue=default --tries=3 --timeout=90"
    # No code volume mount
    volumes:
      - "locker-storage:/var/www/html/storage/app/public"
    networks:
      - locker-net
    depends_on:
      app:
        condition: service_healthy
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      mqtt:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "php artisan queue:monitor default || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
  event-worker:
    image: ghcr.io/open-locker/locker-backend:${BACKEND_IMAGE_TAG:-latest}
    restart: unless-stopped
    stop_signal: SIGTERM
    environment:
      AUTORUN_ENABLED: "false"
      PUID: "1000"
      PGID: "1000"
      WWWUSER: "1000"
      APP_ENV: production
      DB_HOST: db
      REDIS_HOST: redis
      MQTT_BROKER_HOST: mqtt
    command: "php artisan queue:work --queue=events --tries=3 --timeout=90"
    volumes:
      - "locker-storage:/var/www/html/storage/app/public"
    networks:
      - locker-net
    depends_on:
      app:
        condition: service_healthy
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      mqtt:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "php artisan queue:monitor events || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
  mqtt-listener:
    image: ghcr.io/open-locker/locker-backend:${BACKEND_IMAGE_TAG:-latest}
    restart: unless-stopped
    stop_signal: SIGTERM
    environment:
      AUTORUN_ENABLED: "false"
      PUID: "1000"
      PGID: "1000"
      WWWUSER: "1000"
      APP_ENV: production
      DB_HOST: db
      REDIS_HOST: redis
      MQTT_BROKER_HOST: mqtt
    command: "php artisan mqtt:listen"
    volumes:
      - "locker-storage:/var/www/html/storage/app/public"
    networks:
      - locker-net
    depends_on:
      app:
        condition: service_healthy
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      mqtt:
        condition: service_started
  mqtt:
    image: iegomez/mosquitto-go-auth:latest
    restart: unless-stopped
    ports:
      - "1883:1883"
    volumes:
      - "./mosquitto/mosquitto.conf:/etc/mosquitto/mosquitto.conf:ro"
    environment:
      TZ: UTC
    networks:
      - locker-net
    depends_on:
      app:
        condition: service_healthy

  redis:
    image: "redis:alpine"
    volumes:
      - "locker-redis:/data"
    networks:
      - locker-net
    healthcheck:
      test:
        - CMD
        - redis-cli
        - ping
      retries: 3
      timeout: 5s
  db:
    image: "postgres:17"
    environment:
      PGPASSWORD: "${DB_PASSWORD:-secret}"
      POSTGRES_DB: "${DB_DATABASE}"
      POSTGRES_USER: "${DB_USERNAME}"
      POSTGRES_PASSWORD: "${DB_PASSWORD:-secret}"
    volumes:
      - "locker-pgsql:/var/lib/postgresql/data"
    networks:
      - locker-net
    healthcheck:
      test:
        - CMD
        - pg_isready
        - "-q"
        - "-d"
        - "${DB_DATABASE}"
        - "-U"
        - "${DB_USERNAME}"
      retries: 3
      timeout: 5s
networks:
  locker-net:
    driver: bridge
volumes:
  locker-redis:
    driver: local
  locker-pgsql:
    driver: local
  locker-storage:
    driver: local
